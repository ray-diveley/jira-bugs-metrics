<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jira Bug Metrics Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }
        .metric-card:hover {
            transform: translateY(-5px);
        }
        .metric-label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }
        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        .metric-unit {
            color: #999;
            font-size: 0.85em;
        }
        .issues-table {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        tr:hover {
            background: #f8f9ff;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 500;
        }
        .status-done { background: #d4edda; color: #155724; }
        .status-progress { background: #fff3cd; color: #856404; }
        .status-todo { background: #f8d7da; color: #721c24; }
        .priority-row {
            background: #f8f9ff;
            font-size: 0.9em;
        }
        .priority-row td {
            padding-left: 30px;
            border-bottom: 1px solid #e8e9f0;
        }
        .expandable {
            cursor: pointer;
            user-select: none;
        }
        .expandable:hover {
            background: #f0f1ff;
        }
        .expand-icon {
            display: inline-block;
            margin-right: 5px;
            transition: transform 0.2s;
        }
        .expand-icon.expanded {
            transform: rotate(90deg);
        }
        .load-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-bottom: 20px;
            transition: all 0.2s;
        }
        .load-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .timestamp {
            color: white;
            text-align: center;
            margin-bottom: 20px;
            font-size: 0.9em;
            opacity: 0.9;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .modal-header {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            color: #666;
            font-weight: 500;
            margin-bottom: 8px;
        }
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.2s;
        }
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }
        .btn {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5568d3;
        }
        .btn-secondary {
            background: #e0e0e0;
            color: #666;
        }
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        .config-btn {
            background: white;
            color: #667eea;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 10px;
        }
        .config-btn:hover {
            background: #f8f9ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üêõ Jira Bug Metrics Dashboard</h1>
        <div class="timestamp" id="timestamp"></div>
        
        <div style="text-align: center; margin-bottom: 20px;">
            <button class="load-btn" onclick="loadLatestMetrics()">üîÑ Refresh Metrics</button>
            <button class="config-btn" onclick="openConfig()">‚öôÔ∏è Configure Dates</button>
            <button class="config-btn" onclick="runMetrics()">‚ñ∂Ô∏è Run Collection</button>
            <button class="load-btn" onclick="location.href='kpi.html'" style="background: #48bb78;">üìä SLA KPIs</button>
            <button class="load-btn" onclick="location.href='trends.html'" style="background: #ed8936;">üìà Trends</button>
        </div>
        
        <div id="error-msg" class="error" style="display:none;"></div>
        
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Total Issues</div>
                <div class="metric-value" id="total-count">--</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Avg Open Duration</div>
                <div class="metric-value" id="avg-open">--</div>
                <div class="metric-unit">days</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Avg Resolution Time</div>
                <div class="metric-value" id="avg-resolution">--</div>
                <div class="metric-unit">days</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Avg Comment Response</div>
                <div class="metric-value" id="avg-comment">--</div>
                <div class="metric-unit">days</div>
            </div>
        </div>

        <div class="issues-table" style="margin-bottom: 30px;">
            <h2 style="margin-bottom: 20px; color: #333;">üìû Manager Response Patterns (by SLA)</h2>
            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px; font-style: italic;">
                ‚ÑπÔ∏è Note: This tracks ALL manager actions across all times, not just during on-call shifts. 
                üí¨ = Manager commented first (good communication). üë§ = Manager assigned directly (fast delegation).
            </p>
            <table>
                <thead>
                    <tr>
                        <th>Manager / Ticket</th>
                        <th>Summary</th>
                        <th>Assigned To</th>
                        <th>Created</th>
                        <th>First Action</th>
                        <th>SLA Status</th>
                        <th>Action Type</th>
                        <th>Response (hours)</th>
                        <th>Open (days)</th>
                        <th>Resolved</th>
                        <th>Resolution Time (days)</th>
                    </tr>
                </thead>
                <tbody id="oncall-tbody">
                    <tr><td colspan="11" style="text-align:center; color:#999;">Click "Refresh Metrics" to load data</td></tr>
                </tbody>
            </table>
        </div>

        <div class="issues-table" style="margin-bottom: 30px;">
            <h2 style="margin-bottom: 20px; color: #333;">üë®‚Äçüíª Developer/Assignee Metrics <span id="date-range" style="font-size: 0.7em; color: #666; font-weight: normal;"></span></h2>
            <table>
                <thead>
                    <tr>
                        <th>Assignee</th>
                        <th>Total Assigned</th>
                        <th>Active (Not Done)</th>
                        <th>Completed</th>
                        <th>Avg Resolution Time (days)</th>
                    </tr>
                </thead>
                <tbody id="assignee-tbody">
                    <tr><td colspan="5" style="text-align:center; color:#999;">Click "Refresh Metrics" to load data</td></tr>
                </tbody>
            </table>
        </div>

        <div class="issues-table">
            <h2 style="margin-bottom: 20px; color: #333; display: inline-block;">Issue Details</h2>
            <div style="display: inline-block; margin-left: 20px;">
                <label for="assignee-filter" style="color: #666; font-size: 0.9em; margin-right: 8px;">Filter by Assignee:</label>
                <select id="assignee-filter" onchange="filterByAssignee()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9em; background: white; cursor: pointer;">
                    <option value="">All Assignees</option>
                </select>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Key</th>
                        <th>Summary</th>
                        <th>Status</th>
                        <th>Priority</th>
                        <th>Assignee</th>
                        <th>Created</th>
                        <th>First Action</th>
                        <th>SLA Status</th>
                        <th>Open (days)</th>
                        <th>Resolution (days)</th>
                    </tr>
                </thead>
                <tbody id="issues-tbody">
                    <tr><td colspan="10" style="text-align:center; color:#999;">Click "Refresh Metrics" to load data</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Date Configuration Modal -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">üìÖ Configure Date Range</div>
            <div class="form-group">
                <label for="startDate">Start Date</label>
                <input type="date" id="startDate" value="2025-11-01">
            </div>
            <div class="form-group">
                <label for="endDate">End Date</label>
                <input type="date" id="endDate" value="2025-11-19">
            </div>
            <div class="form-group">
                <label for="maxIssues">Max Issues (leave empty for all)</label>
                <input type="number" id="maxIssues" placeholder="e.g., 25, 50, 100" value="50">
            </div>
            <div class="button-group">
                <button class="btn btn-secondary" onclick="closeConfig()">Cancel</button>
                <button class="btn btn-primary" onclick="saveAndRun()">Save & Run Collection</button>
            </div>
        </div>
    </div>

    <script>
        function minutesToDays(minutes) {
            if (minutes === null || minutes === undefined) return '--';
            return (minutes / 1440).toFixed(1);
        }

        function getStatusClass(status) {
            if (!status) return 'status-todo';
            const s = status.toLowerCase();
            if (s.includes('done') || s.includes('resolved')) return 'status-done';
            if (s.includes('progress')) return 'status-progress';
            return 'status-todo';
        }

        function toggleManager(managerId) {
            const rows = document.querySelectorAll(`#${managerId}-row`);
            const icon = document.getElementById(`icon-${managerId}`);
            const isExpanded = rows[0] && rows[0].style.display !== 'none';
            
            rows.forEach(row => {
                row.style.display = isExpanded ? 'none' : 'table-row';
            });
            
            if (icon) {
                icon.classList.toggle('expanded', !isExpanded);
            }
        }

        function toggleSLATickets(slaCategoryId) {
            event.stopPropagation(); // Prevent triggering parent row toggle
            const ticketRows = document.querySelectorAll(`#${slaCategoryId}-ticket`);
            const icon = document.getElementById(`icon-${slaCategoryId}`);
            const isExpanded = ticketRows[0] && ticketRows[0].style.display !== 'none';
            
            ticketRows.forEach(row => {
                row.style.display = isExpanded ? 'none' : 'table-row';
            });
            
            if (icon) {
                icon.classList.toggle('expanded', !isExpanded);
            }
        }

        // Store all metrics data globally for filtering
        let allMetricsData = [];

        function filterByAssignee() {
            const selectedAssignee = document.getElementById('assignee-filter').value;
            const tbody = document.getElementById('issues-tbody');
            
            // Filter data
            const filteredData = selectedAssignee === '' 
                ? allMetricsData 
                : allMetricsData.filter(issue => (issue.assigneeCurrent || 'Unassigned') === selectedAssignee);
            
            // Re-render table with filtered data
            renderIssuesTable(filteredData);
        }

        function renderIssuesTable(metrics) {
            const tbody = document.getElementById('issues-tbody');
            const rows = metrics.map(issue => {
                let slaStatus = '--';
                if (issue.sla && issue.sla.length > 0) {
                    const firstSla = issue.sla[0];
                    const goalHours = firstSla.goalDuration ? (firstSla.goalDuration / (1000 * 60 * 60)).toFixed(0) : '?';
                    
                    if (firstSla.breached) {
                        slaStatus = `<span style="color: #dc3545; font-weight: bold;">‚ö†Ô∏è Breached (${goalHours}h)</span>`;
                    } else if (firstSla.remainingTime !== null && firstSla.remainingTime > 0) {
                        const hoursRemaining = (firstSla.remainingTime / (1000 * 60 * 60)).toFixed(1);
                        slaStatus = `<span style="color: #28a745;">‚úì ${hoursRemaining}h left (${goalHours}h goal)</span>`;
                    } else if (firstSla.elapsedTime !== null) {
                        slaStatus = `<span style="color: #28a745;">‚úì Met (${goalHours}h)</span>`;
                    }
                }
                
                // Format dates
                const createdDate = issue.created ? new Date(issue.created).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : '--';
                
                // Determine first action (assignment or comment, whichever came first)
                let firstAction = '--';
                const assignTime = issue.firstAssignmentTime ? new Date(issue.firstAssignmentTime) : null;
                const commentTime = issue.firstAssigneeCommentTime ? new Date(issue.firstAssigneeCommentTime) : null;
                const managerTime = issue.firstManagerActionTime ? new Date(issue.firstManagerActionTime) : null;
                
                // Use the earliest action time
                const times = [assignTime, commentTime, managerTime].filter(t => t !== null);
                if (times.length > 0) {
                    const earliest = new Date(Math.min(...times));
                    firstAction = earliest.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                }
                
                return `
                    <tr>
                        <td><strong>${issue.key}</strong></td>
                        <td>${issue.summary || ''}</td>
                        <td><span class="status-badge ${getStatusClass(issue.status)}">${issue.status || 'Unknown'}</span></td>
                        <td>${issue.priority || 'None'}</td>
                        <td>${issue.assigneeCurrent || 'Unassigned'}</td>
                        <td style="font-size: 0.85em; color: #666;">${createdDate}</td>
                        <td style="font-size: 0.85em; color: #667eea; font-weight: 500;">${firstAction}</td>
                        <td>${slaStatus}</td>
                        <td>${minutesToDays(issue.openDurationMinutes)}</td>
                        <td>${minutesToDays(issue.timeToResolutionMinutes)}</td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = rows || '<tr><td colspan="10" style="text-align:center; color:#999;">No issues found</td></tr>';
        }

        async function loadLatestMetrics() {
            const errorDiv = document.getElementById('error-msg');
            errorDiv.style.display = 'none';
            
            try {
                // Try to get list from API first
                let latestFile = null;
                
                try {
                    const listResponse = await fetch('/api/metrics-files');
                    if (listResponse.ok) {
                        const filesList = await listResponse.json();
                        if (filesList.files && filesList.files.length > 0) {
                            latestFile = filesList.files[filesList.files.length - 1];
                        }
                    }
                } catch (e) {
                    console.log('API not available, trying direct file access');
                }
                
                // If no file found via API, try the most recent known file
                if (!latestFile) {
                    latestFile = 'metrics-2025-11-19T15-35-09-149Z.json';
                }
                
                const response = await fetch(`/data/${latestFile}`);
                if (!response.ok) throw new Error('Failed to load metrics file');
                
                const data = await response.json();
                
                console.log('Loaded data:', data);
                
                // Extract and display date range from config
                const saved = JSON.parse(localStorage.getItem('jiraConfig') || '{}');
                const dateRangeText = saved.startDate && saved.endDate 
                    ? `(${saved.startDate} to ${saved.endDate})`
                    : '';
                document.getElementById('date-range').textContent = dateRangeText;
                
                // Update summary metrics
                document.getElementById('total-count').textContent = data.summary.count || 0;
                document.getElementById('avg-open').textContent = minutesToDays(data.summary.avgOpenDurationMinutes);
                document.getElementById('avg-resolution').textContent = minutesToDays(data.summary.avgTimeToResolutionMinutes);
                document.getElementById('avg-comment').textContent = minutesToDays(data.summary.avgTimeToFirstAssigneeCommentMinutes);
                document.getElementById('timestamp').textContent = `Last updated: ${new Date(data.generatedAt).toLocaleString()}`;
                
                console.log('Updated summary cards');
                
                // Store all metrics for filtering
                allMetricsData = data.metrics;
                
                // Populate assignee filter dropdown
                const assignees = [...new Set(data.metrics.map(issue => issue.assigneeCurrent || 'Unassigned'))].sort();
                const assigneeFilter = document.getElementById('assignee-filter');
                assigneeFilter.innerHTML = '<option value="">All Assignees</option>' + 
                    assignees.map(assignee => `<option value="${assignee}">${assignee}</option>`).join('');
                
                // Render initial table with all data
                renderIssuesTable(data.metrics);
                console.log('Updated table with', data.metrics.length, 'rows');
                
                // Calculate assignee statistics
                const assigneeStats = {};
                const doneStatuses = ['done', 'closed', 'complete', 'completed', 'resolved'];
                
                data.metrics.forEach(issue => {
                    const assignee = issue.assigneeCurrent || 'Unassigned';
                    if (!assigneeStats[assignee]) {
                        assigneeStats[assignee] = {
                            total: 0,
                            active: 0,
                            completed: 0,
                            resolutionTimes: []
                        };
                    }
                    assigneeStats[assignee].total++;
                    
                    const status = (issue.status || '').toLowerCase();
                    const isCompleted = doneStatuses.some(s => status.includes(s)) || issue.resolutionDate;
                    
                    if (isCompleted) {
                        assigneeStats[assignee].completed++;
                        if (issue.timeToResolutionMinutes !== null) {
                            assigneeStats[assignee].resolutionTimes.push(issue.timeToResolutionMinutes);
                        }
                    } else {
                        assigneeStats[assignee].active++;
                    }
                });
                
                // Update assignee table
                const assigneeTbody = document.getElementById('assignee-tbody');
                const assigneeRows = Object.entries(assigneeStats)
                    .sort((a, b) => b[1].total - a[1].total)
                    .map(([assignee, stats]) => {
                        const avgResolution = stats.resolutionTimes.length > 0
                            ? minutesToDays(stats.resolutionTimes.reduce((a, b) => a + b, 0) / stats.resolutionTimes.length)
                            : '--';
                        return `
                            <tr>
                                <td><strong>${assignee}</strong></td>
                                <td>${stats.total}</td>
                                <td><strong style="color: ${stats.active > 0 ? '#856404' : '#28a745'}">${stats.active}</strong></td>
                                <td>${stats.completed}</td>
                                <td>${avgResolution}</td>
                            </tr>
                        `;
                    }).join('');
                
                assigneeTbody.innerHTML = assigneeRows;
                console.log('Updated assignee stats for', Object.keys(assigneeStats).length, 'assignees');
                
                // Calculate on-call manager response patterns with SLA breakdown
                console.log('[DEBUG] Starting manager response calculation');
                const managerResponsePatterns = {};
                const managerList2 = ['Max', 'Grigoriy', 'Brad', 'Randy', 'Jeff', 'Akshay', 'Evgeniy'];
                
                data.metrics.forEach(issue => {
                    if (issue.assignedBy && issue.firstManagerActionTime) {
                        const isManager = managerList2.some(mgr => issue.assignedBy.includes(mgr));
                        if (isManager) {
                            const manager = issue.assignedBy;
                            
                            // Determine SLA status based on MANAGER response time, not Jira's SLA
                            let slaCategory = 'No SLA Data';
                            if (issue.sla && issue.sla.length > 0 && issue.timeToFirstManagerActionMinutes !== null) {
                                const firstSla = issue.sla[0];
                                const goalMinutes = firstSla.goalDuration ? firstSla.goalDuration / (1000 * 60) : null;
                                
                                if (goalMinutes !== null) {
                                    // Check if manager responded within the SLA goal
                                    if (issue.timeToFirstManagerActionMinutes > goalMinutes) {
                                        slaCategory = 'SLA Breached';
                                    } else {
                                        slaCategory = 'SLA Met';
                                    }
                                }
                            }
                            
                            if (!managerResponsePatterns[manager]) {
                                managerResponsePatterns[manager] = {
                                    count: 0,
                                    commentFirst: 0,
                                    assignFirst: 0,
                                    firstActionTimes: [],
                                    bySLA: {}
                                };
                            }
                            
                            const pattern = managerResponsePatterns[manager];
                            pattern.count++;
                            
                            if (issue.timeToFirstManagerActionMinutes !== null) {
                                pattern.firstActionTimes.push(issue.timeToFirstManagerActionMinutes);
                            }
                            
                            if (issue.firstManagerActionType === 'comment') {
                                pattern.commentFirst++;
                            } else if (issue.firstManagerActionType === 'assignment') {
                                pattern.assignFirst++;
                            }
                            
                            // Group by SLA
                            if (!pattern.bySLA[slaCategory]) {
                                pattern.bySLA[slaCategory] = {
                                    count: 0,
                                    times: [],
                                    tickets: []
                                };
                            }
                            
                            const responseTime = issue.timeToFirstManagerActionMinutes !== null 
                                ? issue.timeToFirstManagerActionMinutes / 60 
                                : null;
                            
                            pattern.bySLA[slaCategory].count++;
                            if (responseTime !== null) {
                                pattern.bySLA[slaCategory].times.push(responseTime);
                            }
                            pattern.bySLA[slaCategory].tickets.push({
                                key: issue.key,
                                summary: issue.summary,
                                responseTime: responseTime !== null ? responseTime.toFixed(1) : '--',
                                actionType: issue.firstManagerActionType || 'unknown',
                                url: `https://m3gr.atlassian.net/browse/${issue.key}`,
                                created: issue.created,
                                firstAction: issue.firstManagerActionTime,
                                sla: issue.sla,
                                openDurationMinutes: issue.openDurationMinutes,
                                timeToResolutionMinutes: issue.timeToResolutionMinutes,
                                status: issue.status,
                                assignee: issue.assigneeCurrent || 'Unassigned',
                                resolutionDate: issue.resolutionDate
                            });
                        }
                    }
                });
                
                // Ensure all 7 managers are in the list, even with 0 tickets
                managerList2.forEach(mgr => {
                    // Find if manager already exists (partial name match)
                    const existingManager = Object.keys(managerResponsePatterns).find(key => key.includes(mgr));
                    if (!existingManager) {
                        // Add manager with 0 tickets
                        managerResponsePatterns[mgr] = {
                            count: 0,
                            commentFirst: 0,
                            assignFirst: 0,
                            firstActionTimes: [],
                            bySLA: {}
                        };
                    }
                });
                
                const oncallTbody = document.getElementById('oncall-tbody');
                let oncallRows = '';
                const slaOrder = ['SLA Breached', 'SLA Met (On Time)', 'SLA Met', 'No SLA Data'];
                
                // Sort: active managers first (by count), then alphabetically by name for inactive
                const sortedManagers = Object.entries(managerResponsePatterns).sort((a, b) => {
                    if (b[1].count !== a[1].count) {
                        return b[1].count - a[1].count; // Sort by count descending
                    }
                    return a[0].localeCompare(b[0]); // Then alphabetically
                });
                
                sortedManagers.forEach(([manager, pattern], idx) => {
                    const avgFirstAction = pattern.firstActionTimes.length > 0
                        ? (pattern.firstActionTimes.reduce((a, b) => a + b, 0) / pattern.firstActionTimes.length / 60).toFixed(1)
                        : '--';
                    const commentFirstPct = pattern.count > 0
                        ? ((pattern.commentFirst / pattern.count) * 100).toFixed(0)
                        : '0';
                    
                    const allTimes = pattern.firstActionTimes.map(t => t / 60);
                    const min = allTimes.length > 0 ? Math.min(...allTimes).toFixed(1) : '--';
                    const max = allTimes.length > 0 ? Math.max(...allTimes).toFixed(1) : '--';
                    
                    const managerId = `oncall-${idx}`;
                    const hasSLABreakdown = Object.keys(pattern.bySLA).length > 0;
                    const commentStyle = pattern.commentFirst > pattern.assignFirst ? 'color: #28a745; font-weight: bold;' : '';
                    
                    // Main manager row
                    const managerCaret = hasSLABreakdown ? `<span class="expand-icon" id="icon-${managerId}">‚ñ∂</span>` : '';
                    const managerClass = hasSLABreakdown ? 'expandable' : '';
                    const managerClick = hasSLABreakdown ? `onclick="toggleManager('${managerId}')"` : '';
                    
                    oncallRows += `
                        <tr class="${managerClass}" ${managerClick} style="background: #f8f9fa; font-weight: bold;">
                            <td>${managerCaret}<strong>${manager}</strong></td>
                            <td colspan="2" style="text-align: center;">${pattern.count} tickets</td>
                            <td style="${commentStyle}">Avg: ${avgFirstAction}h</td>
                            <td>üí¨ ${commentFirstPct}%</td>
                            <td colspan="4">Range: ${min}h - ${max}h</td>
                            <td colspan="2"></td>
                        </tr>
                    `;
                    
                    // SLA breakdown rows
                    slaOrder.forEach(slaCategory => {
                        if (pattern.bySLA[slaCategory]) {
                            const slaStats = pattern.bySLA[slaCategory];
                            const slaAvg = slaStats.times.length > 0
                                ? (slaStats.times.reduce((a, b) => a + b, 0) / slaStats.times.length).toFixed(1)
                                : '--';
                            const slaMin = slaStats.times.length > 0 ? Math.min(...slaStats.times).toFixed(1) : '--';
                            const slaMax = slaStats.times.length > 0 ? Math.max(...slaStats.times).toFixed(1) : '--';
                            const slaCategoryId = `${managerId}-${slaCategory.replace(/\s+/g, '-')}`;
                            const hasTickets = slaStats.tickets.length > 0;
                            
                            let slaIcon = '‚îú‚îÄ';
                            let slaColor = '#666';
                            if (slaCategory === 'SLA Breached') {
                                slaIcon = '‚îú‚îÄ ‚ö†Ô∏è';
                                slaColor = '#dc3545';
                            } else if (slaCategory.includes('Met')) {
                                slaIcon = '‚îú‚îÄ ‚úì';
                                slaColor = '#28a745';
                            }
                            
                            const slaCaret = hasTickets ? `<span class="expand-icon" id="icon-${slaCategoryId}" style="font-size: 0.8em;">‚ñ∂</span> ` : '';
                            const slaClass = hasTickets ? 'priority-row expandable' : 'priority-row';
                            const slaClick = hasTickets ? `onclick="toggleSLATickets('${slaCategoryId}')"` : '';
                            
                            // Calculate comment first % for this SLA category
                            const commentFirstCount = slaStats.tickets.filter(t => t.actionType === 'comment').length;
                            const slaCommentPct = slaStats.count > 0 ? ((commentFirstCount / slaStats.count) * 100).toFixed(0) : '0';
                            const slaCommentStyle = commentFirstCount > (slaStats.count / 2) ? 'color: #28a745; font-weight: bold;' : '';
                            
                            oncallRows += `
                                <tr class="${slaClass}" id="${managerId}-row" style="display:none; background: #fafbfc;" ${slaClick}>
                                    <td style="padding-left: 30px;">${slaCaret}<span style="color: ${slaColor}">${slaIcon} ${slaCategory}</span></td>
                                    <td>${slaStats.count} tickets</td>
                                    <td></td>
                                    <td colspan="2" style="text-align: center;">Avg: ${slaAvg}h</td>
                                    <td style="${slaCommentStyle}">üí¨ ${slaCommentPct}%</td>
                                    <td colspan="3">Range: ${slaMin}h - ${slaMax}h</td>
                                    <td colspan="2"></td>
                                </tr>
                            `;
                            
                            // Individual ticket rows
                            slaStats.tickets.forEach(ticket => {
                                const actionBadge = ticket.actionType === 'comment' 
                                    ? '<span style="color: #28a745; font-size: 0.85em;">üí¨ Comment</span>'
                                    : '<span style="color: #667eea; font-size: 0.85em;">üë§ Assign</span>';
                                
                                // Format dates
                                const createdDate = ticket.created ? new Date(ticket.created).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : '--';
                                const firstActionDate = ticket.firstAction ? new Date(ticket.firstAction).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : '--';
                                
                                // SLA Status - recalculate based on manager response time
                                let slaStatus = '--';
                                if (ticket.sla && ticket.sla.length > 0) {
                                    const firstSla = ticket.sla[0];
                                    const goalHours = firstSla.goalDuration ? (firstSla.goalDuration / (1000 * 60 * 60)).toFixed(0) : '?';
                                    
                                    // Calculate if manager breached SLA based on their response time
                                    const responseHours = parseFloat(ticket.responseTime);
                                    const goalHoursNum = parseFloat(goalHours);
                                    
                                    if (!isNaN(responseHours) && !isNaN(goalHoursNum)) {
                                        if (responseHours > goalHoursNum) {
                                            slaStatus = `<span style="color: #dc3545; font-weight: bold;">‚ö†Ô∏è Breached (${goalHours}h)</span>`;
                                        } else {
                                            slaStatus = `<span style="color: #28a745;">‚úì Met (${goalHours}h)</span>`;
                                        }
                                    } else {
                                        slaStatus = `<span style="color: #666;">Goal: ${goalHours}h</span>`;
                                    }
                                }
                                
                                const openDays = minutesToDays(ticket.openDurationMinutes);
                                const resolutionDays = minutesToDays(ticket.timeToResolutionMinutes);
                                const resolvedDate = ticket.resolutionDate ? new Date(ticket.resolutionDate).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : '--';
                                
                                oncallRows += `
                                    <tr class="priority-row" id="${slaCategoryId}-ticket" style="display:none; background: #f0f1ff;">
                                        <td style="padding-left: 60px;">‚îî‚îÄ <a href="${ticket.url}" target="_blank" style="color: #667eea; text-decoration: none;">${ticket.key}</a></td>
                                        <td style="font-size: 0.9em; color: #666;">${ticket.summary}</td>
                                        <td style="font-size: 0.9em; color: #333; font-weight: 500;">${ticket.assignee}</td>
                                        <td style="font-size: 0.85em; color: #666;">${createdDate}</td>
                                        <td style="font-size: 0.85em; color: #667eea;">${firstActionDate}</td>
                                        <td>${slaStatus}</td>
                                        <td>${actionBadge}</td>
                                        <td>${ticket.responseTime}h</td>
                                        <td>${openDays}</td>
                                        <td style="font-size: 0.85em; color: #666;">${resolvedDate}</td>
                                        <td>${resolutionDays}</td>
                                    </tr>
                                `;
                            });
                        }
                    });
                });
                
                oncallTbody.innerHTML = oncallRows;
                console.log('Updated manager response patterns for', sortedManagers.length, 'managers (including inactive)');
                
            } catch (error) {
                errorDiv.textContent = `Error: ${error.message}`;
                errorDiv.style.display = 'block';
                console.error('Error loading metrics:', error);
            }
        }

        // Auto-load on page load
        window.addEventListener('load', loadLatestMetrics);

        function openConfig() {
            // Load current values from localStorage if available
            const saved = JSON.parse(localStorage.getItem('jiraConfig') || '{}');
            document.getElementById('startDate').value = saved.startDate || '2025-11-01';
            document.getElementById('endDate').value = saved.endDate || new Date().toISOString().split('T')[0];
            document.getElementById('maxIssues').value = saved.maxIssues || '50';
            document.getElementById('configModal').style.display = 'block';
        }

        function closeConfig() {
            document.getElementById('configModal').style.display = 'none';
        }

        async function saveAndRun() {
            const config = {
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                maxIssues: document.getElementById('maxIssues').value
            };
            
            // Save to localStorage
            localStorage.setItem('jiraConfig', JSON.stringify(config));
            closeConfig();
            
            // Show loading message
            const errorDiv = document.getElementById('error-msg');
            errorDiv.style.display = 'block';
            errorDiv.style.background = '#d1ecf1';
            errorDiv.style.color = '#0c5460';
            errorDiv.textContent = `Running metrics collection for ${config.startDate} to ${config.endDate}...`;
            
            try {
                // Call the API to update .env and run collection
                const response = await fetch('/api/run-metrics', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                if (response.ok) {
                    errorDiv.textContent = 'Collection complete! Refreshing dashboard...';
                    setTimeout(() => {
                        loadLatestMetrics();
                        errorDiv.style.display = 'none';
                    }, 1000);
                } else {
                    throw new Error('Failed to run metrics collection');
                }
            } catch (error) {
                errorDiv.style.background = '#f8d7da';
                errorDiv.style.color = '#721c24';
                errorDiv.textContent = 'Could not auto-run. Please run "npm start" in terminal with your chosen dates.';
            }
        }

        async function runMetrics() {
            const errorDiv = document.getElementById('error-msg');
            errorDiv.style.display = 'block';
            errorDiv.style.background = '#d1ecf1';
            errorDiv.style.color = '#0c5460';
            errorDiv.textContent = 'Running metrics collection with current .env settings...';
            
            try {
                const response = await fetch('/api/run-metrics', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                
                if (response.ok) {
                    errorDiv.textContent = 'Collection complete! Refreshing dashboard...';
                    setTimeout(() => {
                        loadLatestMetrics();
                        errorDiv.style.display = 'none';
                    }, 1000);
                } else {
                    throw new Error('Failed to run');
                }
            } catch (error) {
                errorDiv.style.background = '#fff3cd';
                errorDiv.style.color = '#856404';
                errorDiv.textContent = '‚ö†Ô∏è Auto-run not available. Please run "npm start" in your terminal.';
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('configModal');
            if (event.target === modal) {
                closeConfig();
            }
        }
    </script>
</body>
</html>
