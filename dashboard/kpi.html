<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SLA Performance KPIs - Jira Bug Metrics</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    header {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    h1 {
      color: #2d3748;
      font-size: 28px;
    }
    
    .nav-buttons {
      display: flex;
      gap: 10px;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-1px);
    }
    
    .btn-secondary {
      background: #48bb78;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #38a169;
    }
    
    /* KPI Cards Grid */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .kpi-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
    }
    
    .kpi-card:hover {
      transform: translateY(-5px);
    }
    
    .kpi-label {
      color: #718096;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 10px;
    }
    
    .kpi-value {
      color: #2d3748;
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 5px;
    }
    
    .kpi-value.success {
      color: #48bb78;
    }
    
    .kpi-value.warning {
      color: #ed8936;
    }
    
    .kpi-value.danger {
      color: #f56565;
    }
    
    .kpi-trend {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
      margin-top: 10px;
    }
    
    .kpi-trend.up {
      color: #48bb78;
    }
    
    .kpi-trend.down {
      color: #f56565;
    }
    
    /* Charts and Tables */
    .section {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .section-title {
      color: #2d3748;
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e2e8f0;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }
    
    th {
      background: #f7fafc;
      color: #4a5568;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
    }
    
    tr:hover {
      background: #f7fafc;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .badge-success {
      background: #c6f6d5;
      color: #22543d;
    }
    
    .badge-danger {
      background: #fed7d7;
      color: #742a2a;
    }
    
    .badge-warning {
      background: #feebc8;
      color: #744210;
    }
    
    .badge-info {
      background: #bee3f8;
      color: #2c5282;
    }
    
    .progress-bar-container {
      width: 100%;
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #48bb78 0%, #38a169 100%);
      transition: width 0.5s ease;
    }
    
    .chart-container {
      width: 100%;
      height: 300px;
      margin-top: 20px;
    }
    
    .bar-chart {
      display: flex;
      align-items: flex-end;
      justify-content: space-around;
      height: 250px;
      padding: 20px 0;
      gap: 10px;
    }
    
    .bar {
      flex: 1;
      background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
      border-radius: 4px 4px 0 0;
      min-height: 20px;
      position: relative;
      transition: all 0.3s ease;
    }
    
    .bar:hover {
      opacity: 0.8;
      transform: scaleY(1.05);
    }
    
    .bar-label {
      position: absolute;
      bottom: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      color: #4a5568;
      white-space: nowrap;
    }
    
    .bar-value {
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      font-weight: 600;
      color: #2d3748;
    }
    
    .period-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #718096;
    }
    
    .no-data {
      text-align: center;
      padding: 40px;
      color: #a0aec0;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>üìä SLA Performance KPIs</h1>
        <div id="period-display" style="color: #718096; font-size: 14px; margin-top: 5px;"></div>
      </div>
      <div class="nav-buttons">
        <button class="btn btn-secondary" onclick="location.href='index.html'">‚Üê Main Dashboard</button>
        <button class="btn btn-secondary" onclick="location.href='trends.html'">üìà View Trends</button>
        <button class="btn btn-primary" onclick="refreshKPIs()">üîÑ Refresh KPIs</button>
      </div>
    </header>
    
    <!-- Main KPI Cards -->
    <div class="kpi-grid" id="kpi-cards">
      <div class="loading">Loading KPIs...</div>
    </div>
    
    <!-- Manager Performance -->
    <div class="section">
      <h2 class="section-title">Manager SLA Performance</h2>
      <table id="manager-table">
        <thead>
          <tr>
            <th>Manager</th>
            <th>Compliance Rate</th>
            <th>Met SLA</th>
            <th>Breached SLA</th>
            <th>Pending</th>
            <th>Total Tickets</th>
            <th>Avg Response Time</th>
            <th>Performance</th>
          </tr>
        </thead>
        <tbody id="manager-tbody">
          <tr><td colspan="8" class="loading">Loading...</td></tr>
        </tbody>
      </table>
    </div>
    
    <!-- Response Time Distribution -->
    <div class="section">
      <h2 class="section-title">Response Time Distribution</h2>
      <div class="bar-chart" id="response-chart"></div>
    </div>
    
    <!-- Day of Week Analysis -->
    <div class="section">
      <h2 class="section-title">Performance by Day of Week</h2>
      <table id="day-table">
        <thead>
          <tr>
            <th>Day</th>
            <th>Total Tickets</th>
            <th>Met SLA</th>
            <th>Breached</th>
            <th>Compliance Rate</th>
            <th>Progress</th>
          </tr>
        </thead>
        <tbody id="day-tbody">
          <tr><td colspan="6" class="loading">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
  
  <script>
    let currentKPIs = null;
    
    async function loadKPIs() {
      try {
        // Load latest metrics file
        const metricsResponse = await fetch('/api/latest-metrics');
        const metricsData = await metricsResponse.json();
        
        // Calculate KPIs
        currentKPIs = calculateKPIs(metricsData);
        
        // Display period
        const startDate = localStorage.getItem('startDate') || 'N/A';
        const endDate = localStorage.getItem('endDate') || 'N/A';
        document.getElementById('period-display').textContent = `Period: ${startDate} to ${endDate}`;
        
        // Render all sections
        renderKPICards(currentKPIs);
        renderManagerTable(currentKPIs);
        renderResponseChart(currentKPIs);
        renderDayTable(currentKPIs);
      } catch (error) {
        console.error('Error loading KPIs:', error);
        document.getElementById('kpi-cards').innerHTML = '<div class="no-data">Failed to load KPIs</div>';
      }
    }
    
    function calculateKPIs(metricsData) {
      const metrics = metricsData.metrics || [];
      const totalTickets = metrics.length;
      const ticketsWithSLA = metrics.filter(m => m.sla && m.sla.length > 0);
      
      // Calculate SLA compliance
      const slaResults = ticketsWithSLA.map(ticket => {
        const sla = ticket.sla[0];
        const goalHours = sla.goalDuration / (1000 * 60 * 60);
        const responseMinutes = ticket.timeToFirstOnCallActionMinutes;
        
        if (responseMinutes === null) {
          const createdDate = new Date(ticket.created);
          const now = new Date();
          const elapsedMinutes = (now - createdDate) / (1000 * 60);
          return {
            ticket: ticket.key,
            manager: ticket.assignedBy || 'Unassigned',
            met: elapsedMinutes <= (goalHours * 60),
            responseMinutes: null,
            goalMinutes: goalHours * 60,
            status: 'pending'
          };
        }
        
        return {
          ticket: ticket.key,
          manager: ticket.assignedBy || 'Unknown',
          met: responseMinutes <= (goalHours * 60),
          responseMinutes,
          goalMinutes: goalHours * 60,
          status: 'responded'
        };
      });
      
      const metCount = slaResults.filter(r => r.met).length;
      const breachedCount = slaResults.filter(r => !r.met && (r.status === 'responded' || r.status === 'resolved')).length;
      const pendingCount = slaResults.filter(r => r.status === 'pending').length;
      const complianceRate = totalTickets > 0 ? (metCount / totalTickets) * 100 : 0;
      
      // Manager performance
      const managerPerformance = {};
      slaResults.forEach(result => {
        if (!managerPerformance[result.manager]) {
          managerPerformance[result.manager] = { met: 0, breached: 0, pending: 0, total: 0, responseTimes: [] };
        }
        managerPerformance[result.manager].total++;
        if (result.status === 'pending') {
          managerPerformance[result.manager].pending++;
        } else if (result.met) {
          managerPerformance[result.manager].met++;
        } else {
          managerPerformance[result.manager].breached++;
        }
        if (result.responseMinutes !== null) {
          managerPerformance[result.manager].responseTimes.push(result.responseMinutes);
        }
      });
      
      const managerKPIs = Object.entries(managerPerformance).map(([manager, stats]) => {
        const avgResponseMinutes = stats.responseTimes.length > 0 
          ? stats.responseTimes.reduce((a, b) => a + b, 0) / stats.responseTimes.length 
          : 0;
        const avgResponseHours = Math.floor(avgResponseMinutes / 60);
        const avgResponseMins = Math.floor(avgResponseMinutes % 60);
        
        return {
          manager,
          ...stats,
          complianceRate: stats.total > 0 ? ((stats.met / stats.total) * 100).toFixed(1) : 0,
          avgResponseTime: stats.responseTimes.length > 0 ? `${avgResponseHours}h ${avgResponseMins}m` : 'N/A'
        };
      }).sort((a, b) => parseFloat(b.complianceRate) - parseFloat(a.complianceRate));
      
      // Response time distribution
      const distribution = {
        'Under 1h': 0, '1-2h': 0, '2-4h': 0, '4-8h': 0, 'Over 8h': 0, 'No response': 0
      };
      slaResults.forEach(r => {
        if (r.responseMinutes === null) distribution['No response']++;
        else if (r.responseMinutes < 60) distribution['Under 1h']++;
        else if (r.responseMinutes < 120) distribution['1-2h']++;
        else if (r.responseMinutes < 240) distribution['2-4h']++;
        else if (r.responseMinutes < 480) distribution['4-8h']++;
        else distribution['Over 8h']++;
      });
      
      // Day of week analysis
      const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      const dayAnalysis = {};
      metrics.forEach(m => {
        const dayName = days[new Date(m.created).getDay()];
        if (!dayAnalysis[dayName]) dayAnalysis[dayName] = { total: 0, met: 0, breached: 0 };
        dayAnalysis[dayName].total++;
        if (m.sla && m.sla.length > 0 && m.timeToFirstOnCallActionMinutes !== null) {
          const goalMinutes = m.sla[0].goalDuration / (1000 * 60);
          if (m.timeToFirstOnCallActionMinutes <= goalMinutes) dayAnalysis[dayName].met++;
          else dayAnalysis[dayName].breached++;
        }
      });
      
      const dayKPIs = Object.entries(dayAnalysis).map(([day, stats]) => ({
        day,
        ...stats,
        complianceRate: stats.total > 0 ? ((stats.met / stats.total) * 100).toFixed(1) : 0
      }));
      
      // Calculate avg response time for all responded tickets
      const respondedTimes = slaResults.filter(r => r.responseMinutes !== null).map(r => r.responseMinutes);
      const avgResponseMinutes = respondedTimes.length > 0 
        ? respondedTimes.reduce((a, b) => a + b, 0) / respondedTimes.length 
        : 0;
      const avgResponseHours = Math.floor(avgResponseMinutes / 60);
      const avgResponseMins = Math.floor(avgResponseMinutes % 60);
      
      return {
        overall: {
          totalTickets,
          metSLA: metCount,
          breachedSLA: breachedCount,
          pendingSLA: pendingCount,
          complianceRate: complianceRate.toFixed(1),
          avgResponseTime: respondedTimes.length > 0 ? `${avgResponseHours}h ${avgResponseMins}m` : 'N/A'
        },
        managerKPIs,
        responseDistribution: distribution,
        dayKPIs
      };
    }
    
    function renderKPICards(kpis) {
      const { overall } = kpis;
      const complianceRate = parseFloat(overall.complianceRate);
      
      let complianceClass = 'success';
      if (complianceRate < 70) complianceClass = 'danger';
      else if (complianceRate < 85) complianceClass = 'warning';
      
      const html = `
        <div class="kpi-card">
          <div class="kpi-label">SLA Compliance Rate</div>
          <div class="kpi-value ${complianceClass}">${overall.complianceRate}%</div>
          <div class="progress-bar-container">
            <div class="progress-bar" style="width: ${overall.complianceRate}%"></div>
          </div>
        </div>
        
        <div class="kpi-card">
          <div class="kpi-label">Total Tickets</div>
          <div class="kpi-value">${overall.totalTickets}</div>
          <div style="color: #718096; font-size: 14px; margin-top: 10px;">
            In current period
          </div>
        </div>
        
        <div class="kpi-card">
          <div class="kpi-label">Met SLA</div>
          <div class="kpi-value success">${overall.metSLA}</div>
          <div style="color: #718096; font-size: 14px; margin-top: 10px;">
            ‚úÖ Responded within SLA
          </div>
        </div>
        
        <div class="kpi-card">
          <div class="kpi-label">Breached SLA</div>
          <div class="kpi-value danger">${overall.breachedSLA}</div>
          <div style="color: #718096; font-size: 14px; margin-top: 10px;">
            ‚ö†Ô∏è Response time exceeded
          </div>
        </div>
        
        <div class="kpi-card">
          <div class="kpi-label">Avg Response Time</div>
          <div class="kpi-value">${overall.avgResponseTime}</div>
          <div style="color: #718096; font-size: 14px; margin-top: 10px;">
            Time to first manager action
          </div>
        </div>
        
        <div class="kpi-card">
          <div class="kpi-label">Pending Response</div>
          <div class="kpi-value warning">${overall.pendingSLA}</div>
          <div style="color: #718096; font-size: 14px; margin-top: 10px;">
            ‚è≥ Awaiting response
          </div>
        </div>
      `;
      
      document.getElementById('kpi-cards').innerHTML = html;
    }
    
    function renderManagerTable(kpis) {
      const tbody = document.getElementById('manager-tbody');
      
      if (kpis.managerKPIs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="no-data">No manager data available</td></tr>';
        return;
      }
      
      const rows = kpis.managerKPIs.map(m => {
        const rate = parseFloat(m.complianceRate);
        let badgeClass = 'badge-success';
        if (rate < 70) badgeClass = 'badge-danger';
        else if (rate < 85) badgeClass = 'badge-warning';
        
        return `
          <tr>
            <td><strong>${m.manager}</strong></td>
            <td><span class="badge ${badgeClass}">${m.complianceRate}%</span></td>
            <td>${m.met}</td>
            <td>${m.breached}</td>
            <td>${m.pending}</td>
            <td>${m.total}</td>
            <td>${m.avgResponseTime}</td>
            <td>
              <div class="progress-bar-container">
                <div class="progress-bar" style="width: ${m.complianceRate}%"></div>
              </div>
            </td>
          </tr>
        `;
      }).join('');
      
      tbody.innerHTML = rows;
    }
    
    function renderResponseChart(kpis) {
      const dist = kpis.responseDistribution;
      const maxValue = Math.max(...Object.values(dist));
      const chartContainer = document.getElementById('response-chart');
      
      const bars = Object.entries(dist).map(([label, value]) => {
        const height = maxValue > 0 ? (value / maxValue) * 100 : 0;
        return `
          <div class="bar" style="height: ${height}%">
            <div class="bar-value">${value}</div>
            <div class="bar-label">${label}</div>
          </div>
        `;
      }).join('');
      
      chartContainer.innerHTML = bars;
    }
    
    function renderDayTable(kpis) {
      const tbody = document.getElementById('day-tbody');
      
      if (kpis.dayKPIs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="no-data">No data available</td></tr>';
        return;
      }
      
      const rows = kpis.dayKPIs.map(d => {
        const rate = parseFloat(d.complianceRate);
        let badgeClass = 'badge-success';
        if (rate < 70) badgeClass = 'badge-danger';
        else if (rate < 85) badgeClass = 'badge-warning';
        
        return `
          <tr>
            <td><strong>${d.day}</strong></td>
            <td>${d.total}</td>
            <td>${d.met}</td>
            <td>${d.breached}</td>
            <td><span class="badge ${badgeClass}">${d.complianceRate}%</span></td>
            <td>
              <div class="progress-bar-container">
                <div class="progress-bar" style="width: ${d.complianceRate}%"></div>
              </div>
            </td>
          </tr>
        `;
      }).join('');
      
      tbody.innerHTML = rows;
    }
    
    function refreshKPIs() {
      location.reload();
    }
    
    // Load on page load
    loadKPIs();
  </script>
</body>
</html>
