<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SLA Performance KPIs - Jira Bug Metrics</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    header {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    h1 {
      color: #2d3748;
      font-size: 28px;
    }
    
    .nav-buttons {
      display: flex;
      gap: 10px;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-1px);
    }
    
    .btn-secondary {
      background: #48bb78;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #38a169;
    }
    
    /* KPI Cards Grid */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .kpi-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
    }
    
    .kpi-card:hover {
      transform: translateY(-5px);
    }
    
    .kpi-label {
      color: #718096;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 10px;
    }
    
    .kpi-value {
      color: #2d3748;
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 5px;
    }
    
    .kpi-value.success {
      color: #48bb78;
    }
    
    .kpi-value.warning {
      color: #ed8936;
    }
    
    .kpi-value.danger {
      color: #f56565;
    }
    
    .kpi-trend {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
      margin-top: 10px;
    }
    
    .kpi-trend.up {
      color: #48bb78;
    }
    
    .kpi-trend.down {
      color: #f56565;
    }
    
    /* Charts and Tables */
    .section {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .section-title {
      color: #2d3748;
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e2e8f0;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }
    
    th {
      background: #f7fafc;
      color: #4a5568;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
    }
    
    tr:hover {
      background: #f7fafc;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .badge-success {
      background: #c6f6d5;
      color: #22543d;
    }
    
    .badge-danger {
      background: #fed7d7;
      color: #742a2a;
    }
    
    .badge-warning {
      background: #feebc8;
      color: #744210;
    }
    
    .badge-info {
      background: #bee3f8;
      color: #2c5282;
    }
    
    .progress-bar-container {
      width: 100%;
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #48bb78 0%, #38a169 100%);
      transition: width 0.5s ease;
    }
    
    .chart-container {
      width: 100%;
      height: 300px;
      margin-top: 20px;
    }
    
    .bar-chart {
      display: flex;
      align-items: flex-end;
      justify-content: space-around;
      height: 250px;
      padding: 20px 0;
      gap: 10px;
    }
    
    .bar {
      flex: 1;
      background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
      border-radius: 4px 4px 0 0;
      min-height: 20px;
      position: relative;
      transition: all 0.3s ease;
    }
    
    .bar:hover {
      opacity: 0.8;
      transform: scaleY(1.05);
    }
    
    .bar-label {
      position: absolute;
      bottom: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      color: #4a5568;
      white-space: nowrap;
    }
    
    .bar-value {
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      font-weight: 600;
      color: #2d3748;
    }
    
    .period-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #718096;
    }
    
    .no-data {
      text-align: center;
      padding: 40px;
      color: #a0aec0;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>üìä SLA Performance KPIs</h1>
        <div id="period-display" style="color: #718096; font-size: 14px; margin-top: 5px;"></div>
      </div>
      <div class="nav-buttons">
        <button class="btn btn-secondary" onclick="location.href='index.html'">‚Üê Main Dashboard</button>
        <button class="btn btn-secondary" onclick="location.href='trends.html'">üìà View Trends</button>
        <button class="btn btn-primary" onclick="refreshKPIs()">üîÑ Refresh KPIs</button>
      </div>
    </header>
    
    <!-- Main KPI Cards -->
    <div class="kpi-grid" id="kpi-cards">
      <div class="loading">Loading KPIs...</div>
    </div>
    
    <!-- On-Call Performance -->
    <div class="section">
      <h2 class="section-title">üìû On-Call Manager Performance <span style="font-size: 14px; color: #718096;">(First response to new tickets - business hours)</span></h2>
      <table id="oncall-table">
        <thead>
          <tr>
            <th>Manager</th>
            <th>Compliance Rate</th>
            <th>Met SLA</th>
            <th>Breached SLA</th>
            <th>Pending</th>
            <th>Total Tickets</th>
            <th>Avg Response Time</th>
            <th>Performance</th>
          </tr>
        </thead>
        <tbody id="oncall-tbody">
          <tr><td colspan="8" class="loading">Loading...</td></tr>
        </tbody>
      </table>
    </div>
    
    <!-- Developer Performance -->
    <div class="section">
      <h2 class="section-title">üì± Assignee Performance <span style="font-size: 14px; color: #718096;">(Response after assignment - business hours)</span></h2>
      <table id="developer-table">
        <thead>
          <tr>
            <th>Developer</th>
            <th>Compliance Rate</th>
            <th>Met SLA</th>
            <th>Breached SLA</th>
            <th>Pending</th>
            <th>Total Tickets</th>
            <th>Avg Response Time</th>
            <th>Performance</th>
          </tr>
        </thead>
        <tbody id="developer-tbody">
          <tr><td colspan="8" class="loading">Loading...</td></tr>
        </tbody>
      </table>
    </div>
    
    <!-- Response Time Distribution -->
    <div class="section">
      <h2 class="section-title">Response Time Distribution</h2>
      <div class="bar-chart" id="response-chart"></div>
    </div>
    

  </div>
  
  <script>
    let currentKPIs = null;
    
    // Helper function to determine if a ticket was created during off-hours
    function isOffHours(issue) {
      const whoWasOnCall = issue.whoWasOnCall;
      return whoWasOnCall && (
        whoWasOnCall === '[Weekend]' ||
        whoWasOnCall === '[After Hours]' ||
        whoWasOnCall === '[Before Oct 31]'
      );
    }
    
    // Calculate KPIs dynamically from raw metrics (matches main dashboard methodology)
    function calculateDynamicKPIs(metricsData) {
      const metrics = metricsData.metrics || [];
      const goalMinutes = metricsData.slaGoalMinutes || 240;
      
      // Overall SLA calculation - matches report and dashboard methodology
      // Filter to on-call hours only (exclude weekend/after-hours)
      let totalWithSLA = 0;
      let metSLA = 0;
      let responseTimes = [];
      let totalOnCallHoursTickets = 0;
      
      metrics.forEach(issue => {
        
        // Count all tickets during on-call hours
        if (!isOffHours(issue)) {
          totalOnCallHoursTickets++;
        }
        
        // Only count tickets during on-call coverage hours
        if (!isOffHours(issue) && issue.sla && issue.sla.length > 0 && issue.businessHoursToFirstOnCallAction !== null) {
          const firstSla = issue.sla[0];
          const slaGoalMinutes = firstSla.goalDuration ? firstSla.goalDuration / (1000 * 60) : null;
          
          if (slaGoalMinutes !== null) {
            totalWithSLA++;
            const responseTime = issue.businessHoursToFirstOnCallAction;
            responseTimes.push(responseTime);
            
            const breached = responseTime > slaGoalMinutes;
            if (!breached) {
              metSLA++;
            }
          }
        }
      });
      
      const overallComplianceRate = totalWithSLA > 0 ? ((metSLA / totalWithSLA) * 100).toFixed(1) : '0.0';
      const avgResponseTime = responseTimes.length > 0
        ? (responseTimes.reduce((a, b) => a + b, 0) / responseTimes.length).toFixed(0) + ' min'
        : 'N/A';
      
      // On-call manager KPIs
      const managerStats = {};
      metrics.forEach(issue => {
        const manager = issue.whoWasOnCall;
        if (!manager || manager.includes('[')) return; // Skip non-manager entries
        
        if (!managerStats[manager]) {
          managerStats[manager] = { met: 0, breached: 0, pending: 0, total: 0, responseTimes: [] };
        }
        
        if (issue.sla && issue.sla.length > 0 && issue.businessHoursToFirstOnCallAction !== null) {
          const firstSla = issue.sla[0];
          const slaGoalMinutes = firstSla.goalDuration ? firstSla.goalDuration / (1000 * 60) : null;
          
          if (slaGoalMinutes !== null) {
            managerStats[manager].total++;
            const responseTime = issue.businessHoursToFirstOnCallAction;
            managerStats[manager].responseTimes.push(responseTime);
            
            const breached = responseTime > slaGoalMinutes;
            if (!breached) {
              managerStats[manager].met++;
            } else {
              managerStats[manager].breached++;
            }
          }
        }
      });
      
      const onCallManagerKPIs = Object.entries(managerStats).map(([manager, stats]) => {
        const complianceRate = stats.total > 0 ? ((stats.met / stats.total) * 100).toFixed(1) : '0.0';
        const avgResponseTime = stats.responseTimes.length > 0
          ? (stats.responseTimes.reduce((a, b) => a + b, 0) / stats.responseTimes.length).toFixed(0) + ' min'
          : 'N/A';
        
        return {
          manager,
          complianceRate,
          met: stats.met,
          breached: stats.breached,
          pending: stats.pending,
          total: stats.total,
          avgResponseTime
        };
      }).sort((a, b) => parseFloat(b.complianceRate) - parseFloat(a.complianceRate));
      
      // Use pre-calculated developerKPIs from backend and transform to match table structure
      const backendDevKPIs = metricsData.kpis?.developerKPIs || [];
      const developerKPIs = backendDevKPIs.map(dev => ({
        developer: dev.developer,
        complianceRate: dev.slaCompliance || '0.0',
        met: dev.ticketsWithComment || dev.withComment || 0,
        breached: dev.withoutComment || 0,
        pending: 0,
        total: dev.totalAssigned || dev.totalTickets || 0,
        avgResponseTime: dev.avgResponseTime || 'N/A'
      }));
      
      // Day of week analysis
      const dayStats = { Mon: {}, Tue: {}, Wed: {}, Thu: {}, Fri: {}, Sat: {}, Sun: {} };
      Object.keys(dayStats).forEach(day => {
        dayStats[day] = { met: 0, breached: 0, total: 0 };
      });
      
      metrics.forEach(issue => {
        if (!isOffHours(issue) && issue.dayOfWeek && issue.sla && issue.sla.length > 0 && issue.businessHoursToFirstOnCallAction !== null) {
          const firstSla = issue.sla[0];
          const slaGoalMinutes = firstSla.goalDuration ? firstSla.goalDuration / (1000 * 60) : null;
          
          if (slaGoalMinutes !== null) {
            const day = issue.dayOfWeek;
            if (dayStats[day]) {
              dayStats[day].total++;
              const breached = issue.businessHoursToFirstOnCallAction > slaGoalMinutes;
              if (!breached) {
                dayStats[day].met++;
              } else {
                dayStats[day].breached++;
              }
            }
          }
        }
      });
      
      const dayOfWeekKPIs = Object.entries(dayStats).map(([day, stats]) => {
        const complianceRate = stats.total > 0 ? ((stats.met / stats.total) * 100).toFixed(1) : '0.0';
        return { day, ...stats, complianceRate };
      });
      
      // Response time distribution
      const distribution = {
        'Under 1 hour': 0,
        '1-2 hours': 0,
        '2-4 hours': 0,
        '4-8 hours': 0,
        'Over 8 hours': 0,
        'No response': 0
      };
      
      responseTimes.forEach(minutes => {
        if (minutes === null || minutes === undefined) {
          distribution['No response']++;
        } else if (minutes < 60) {
          distribution['Under 1 hour']++;
        } else if (minutes < 120) {
          distribution['1-2 hours']++;
        } else if (minutes < 240) {
          distribution['2-4 hours']++;
        } else if (minutes < 480) {
          distribution['4-8 hours']++;
        } else {
          distribution['Over 8 hours']++;
        }
      });
      
      return {
        overall: {
          complianceRate: overallComplianceRate,
          totalTickets: totalOnCallHoursTickets,
          metSLA: metSLA,
          breachedSLA: totalWithSLA - metSLA,
          avgResponseTime: avgResponseTime,
          pendingSLA: totalOnCallHoursTickets - totalWithSLA
        },
        onCallManagerKPIs,
        managerKPIs: onCallManagerKPIs, // Combined table expects this name
        developerKPIs,
        dayOfWeekKPIs,
        responseTimeDistribution: distribution
      };
    }
    
    async function loadKPIs() {
      try {
        // Load latest metrics file which now includes pre-calculated KPIs
        const metricsResponse = await fetch('/api/latest-metrics');
        const metricsData = await metricsResponse.json();
        
        // The backend now calculates KPIs - check if they exist
        if (!metricsData.kpis) {
          console.warn('No KPIs found in metrics data, metrics may need to be regenerated');
          document.getElementById('kpi-cards').innerHTML = '<div class="no-data">KPIs not available. Please run metrics collection again.</div>';
          return;
        }
        
        // Calculate KPIs dynamically from raw metrics to match dashboard methodology
        currentKPIs = calculateDynamicKPIs(metricsData);
        
        // Display period
        const startDate = metricsData.period?.start || localStorage.getItem('startDate') || 'N/A';
        const endDate = metricsData.period?.end || localStorage.getItem('endDate') || 'N/A';
        document.getElementById('period-display').textContent = `Period: ${startDate} to ${endDate}`;
        
        // Render all sections
        renderKPICards(currentKPIs);
        renderOnCallTable(currentKPIs);
        renderDeveloperTable(currentKPIs);
        renderResponseChart(currentKPIs);
      } catch (error) {
        console.error('Error loading KPIs:', error);
        document.getElementById('kpi-cards').innerHTML = '<div class="no-data">Failed to load KPIs. Error: ' + error.message + '</div>';
      }
    }
    
    function renderKPICards(kpis) {
      const { overall } = kpis;
      const complianceRate = parseFloat(overall.complianceRate);
      
      let complianceClass = 'success';
      if (complianceRate < 70) complianceClass = 'danger';
      else if (complianceRate < 85) complianceClass = 'warning';
      
      const html = `
        <div class="kpi-card">
          <div class="kpi-label">SLA Compliance Rate</div>
          <div class="kpi-value ${complianceClass}">${overall.complianceRate}%</div>
          <div class="progress-bar-container">
            <div class="progress-bar" style="width: ${overall.complianceRate}%"></div>
          </div>
          <div style="color: #718096; font-size: 12px; margin-top: 5px;">üìÖ Business hours only</div>
        </div>
        
        <div class="kpi-card">
          <div class="kpi-label">Total Tickets</div>
          <div class="kpi-value">${overall.totalTickets}</div>
          <div style="color: #718096; font-size: 14px; margin-top: 10px;">
            üìÖ Business hours only
          </div>
        </div>
        
        <div class="kpi-card">
          <div class="kpi-label">Met SLA</div>
          <div class="kpi-value success">${overall.metSLA}</div>
          <div style="color: #718096; font-size: 14px; margin-top: 10px;">
            ‚úÖ Responded within SLA
          </div>
        </div>
        
        <div class="kpi-card">
          <div class="kpi-label">Breached SLA</div>
          <div class="kpi-value danger">${overall.breachedSLA}</div>
          <div style="color: #718096; font-size: 14px; margin-top: 10px;">
            ‚ö†Ô∏è Response time exceeded
          </div>
        </div>
        
        <div class="kpi-card">
          <div class="kpi-label">Avg Response Time</div>
          <div class="kpi-value">${overall.avgResponseTime}</div>
          <div style="color: #718096; font-size: 14px; margin-top: 10px;">
            ‚è±Ô∏è Business hours only
          </div>
        </div>
        
        <div class="kpi-card">
          <div class="kpi-label">Pending Response</div>
          <div class="kpi-value warning">${overall.pendingSLA}</div>
          <div style="color: #718096; font-size: 14px; margin-top: 10px;">
            ‚è≥ Awaiting response
          </div>
        </div>
      `;
      
      document.getElementById('kpi-cards').innerHTML = html;
    }
    
    function renderOnCallTable(kpis) {
      const tbody = document.getElementById('oncall-tbody');
      
      if (!kpis.onCallManagerKPIs || kpis.onCallManagerKPIs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="no-data">No on-call manager data available</td></tr>';
        return;
      }
      
      const rows = kpis.onCallManagerKPIs.map(m => {
        const rate = parseFloat(m.complianceRate);
        let badgeClass = 'badge-success';
        if (rate < 70) badgeClass = 'badge-danger';
        else if (rate < 85) badgeClass = 'badge-warning';
        
        return `
          <tr>
            <td><strong>${m.manager}</strong></td>
            <td><span class="badge ${badgeClass}">${m.complianceRate}%</span></td>
            <td>${m.met}</td>
            <td>${m.breached}</td>
            <td>${m.pending}</td>
            <td>${m.total}</td>
            <td>${m.avgResponseTime}</td>
            <td>
              <div class="progress-bar-container">
                <div class="progress-bar" style="width: ${m.complianceRate}%"></div>
              </div>
            </td>
          </tr>
        `;
      }).join('');
      
      tbody.innerHTML = rows;
    }
    
    function renderDeveloperTable(kpis) {
      const tbody = document.getElementById('developer-tbody');
      
      if (!kpis.developerKPIs || kpis.developerKPIs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="no-data">No developer data available</td></tr>';
        return;
      }
      
      const rows = kpis.developerKPIs.map(d => {
        const rate = parseFloat(d.complianceRate);
        let badgeClass = 'badge-success';
        if (rate < 70) badgeClass = 'badge-danger';
        else if (rate < 85) badgeClass = 'badge-warning';
        
        return `
          <tr>
            <td><strong>${d.developer}</strong></td>
            <td><span class="badge ${badgeClass}">${d.complianceRate}%</span></td>
            <td>${d.met}</td>
            <td>${d.breached}</td>
            <td>${d.pending}</td>
            <td>${d.total}</td>
            <td>${d.avgResponseTime}</td>
            <td>
              <div class="progress-bar-container">
                <div class="progress-bar" style="width: ${d.complianceRate}%"></div>
              </div>
            </td>
          </tr>
        `;
      }).join('');
      
      tbody.innerHTML = rows;
    }
    
    function renderResponseChart(kpis) {
      const dist = kpis.responseTimeDistribution;
      if (!dist) {
        document.getElementById('response-chart').innerHTML = '<div class="no-data">No response time data available</div>';
        return;
      }
      const maxValue = Math.max(...Object.values(dist));
      const chartContainer = document.getElementById('response-chart');
      
      const bars = Object.entries(dist).map(([label, value]) => {
        const height = maxValue > 0 ? (value / maxValue) * 100 : 0;
        return `
          <div class="bar" style="height: ${height}%">
            <div class="bar-value">${value}</div>
            <div class="bar-label">${label}</div>
          </div>
        `;
      }).join('');
      
      chartContainer.innerHTML = bars;
    }
    
    function refreshKPIs() {
      location.reload();
    }
    
    // Load on page load
    loadKPIs();
  </script>
</body>
</html>
